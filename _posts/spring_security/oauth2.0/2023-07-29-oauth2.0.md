---
title: OAuth 2.0 에 대해서
date: 2023-07-29 18:10 +09:00
categories: ["Spring Security","OAuth2.0"]
tags: []
image:
    path: spring_security_logo.png
    alt: ""
---

# Introduction

> OAuth 2.0 의 주요 용어, 작동 흐름을 알아본다.
{: .prompt-info }

## OAuth 2.0 기초

> RFC 6749 <br/>
{: .prompt-info }

`OAuth 2.0` 는 `Authorization Protocol` 이다. `Authentication Protocol` 이 아니다. `Access Token` 을 사용해서 authorization 정보를 전달한다.

![oauth2_token](oauth2/oauth2_token.png)

> OAuth 2.0 를 사용하기위해서는 일단 사용되는 용어와 친해지는 것이 중요하다. <br/>
> 인가 서버로서 Keycloak 사용을 전제한다.
{: .prompt-warning }

## 용어

`Resource Owner`
- 보호된 자원에 대한 접근 권한을 부여할 수 있는 주체

`Client`
- 사용자를 ***대신***하여 권한을 부여받고, 사용자의 자원에 접근하는 어플리케이션
- 사용자를 `Authorization Server` 로 안내
- 사용자와의 상호 작용 없이도 권한 부여서버로 부터 직접 권한을 얻을 수 있다

`Resource Server`
- 타 어플리케이션에서 접근하는 사용자의 자원을 가지고 있는 서버
- Access Token 을 검증하고, 권한 체계에 따라서 접근 요청을 승인한다.

`Authorization Server`
- 클라이언트가 사용자 계정에 대한 동의, 접근을 요청할 때 상호 작용하는 서버
- 클라이언트의 권한 부여 요청을 승인 혹은 거부하는 서버

![concept](oauth2/oauth2_concept.png)


## Grant Type Flow

실제 요청을 요구한 *사용자*를 대신해서 *클라이언트*가 *인가서버*로 부터 대리인 역할로 권한을 부여받는 것을 말한다. 

- `Authorization Code`
- access token 을 발급받기 위한 authorization code 를 획득
- `Implicit` ***(Deprecated)***
  - access token 을 바로 획득
  - 보안에 취약하다.
  - js 기반, 모바일 앱에서 사용
  - 인증정보가 담긴 스크립트가 노출된다.
- `Authorization with PKCE`
  - Authorization Code 방식에 Proof Key 를 적용해서 보안 강화
- `Resource Owner Credentials` ***(Deprecated)***
  - Authorization Server 로의 redirect 가 불가능 할때, Authorization Server 를 건너뛰고 Client 가 직접 권한을 획득
- `Client Credentials Grant`
- `Refresh Token Grant`
- `PKCE-enhanced Authorization Code Grant`

![grant-type-flow](oauth2/flow.png)

## 파라미터 설명

`client_id`
- Authorization Server 에 등록된 클라이언트에 대해 생성된 고유 키
- Keycloak 인 경우 realm 에 생성한 client 의 이름에 해당한다.

`client_secret`
- client 생성 시 부여된 secret 값
`response_type`
- 어플리케이션이 Grant Type 하고 있음을 Authorization Server 에게 알려준다.
- `code`, `token`, `id_token` 이 있다.
- 인가서버가 쿼리 문자열에 포함시켜 반환한다.
  - `code=xxxxx.xxxx.xxxx`
`grant_type`
- 권한을 부여하는 방법을 지정한다. 
  - `authorization_code`
  - `password`
  - `client_credentials`
  - `refresh_token`
`redirect_uri`
- `Authorization Server` 가 인증 토큰을 생성해서 클라이언트에게 보내는데, 특정한 uri 로 보내는 것이다. 
- client_id, client_secret 을 누군가 가로챈 상황에서도, client 가 지정한 특정 uri 로만 보내준다.
`scope`
- 데이터에 대한 접근 권한을 설정한다.
- `Authorization Server` 에 등록되지 않은 scope 를 전달하면 오류 발생!
`state`
- 임의의 문자열을 생성해서 요청에 포함시킨다.
- CSRF 공격 방지에 사용된다.

## Authorization Code Grant Type

1. 사용자가 앱에 로그인 요청을 보낸다. 
2. 앱은 인가서버에게 권한 부여를 요청한다.
3. 인가서버는 앱에 임시코드를 보낸다. 
   1. 인가서버는 지정된 redirect_url 로 임시코드를 보낸다.
4. 앱은 인가서버엑 받은 임시코드를 가지고 인가서버에 엑세스토큰을 요청한다.
5. 인가서버는 엑세스토큰을 받고, jwt code 과정을 거친다.
6. 사용자가 해당 자원에 대한 접근 권한이 확인되면 DB에서 데이터를 꺼내서 사용자에게 전달한다.

 
 ### 임시코드 (권한부여코드)

```bash
- response_type=code (필수)
- client_id (필수)
- redirect_uri (선택)
- scope (선택)
- state (선택)
```


### 액세스 토큰 교환

```bash
- grant_type=authorization_code (필수)
- code (필수)
- redirect_uri (권한부여에 포함된 경우 필수)
- client_id (필수)
- client_secret (필수)
```

![grant_type_flow](oauth2/code_grant_flow_chart.png)





## 출처
1. [인프런 강의](https://inf.run/p7wr)
2. [https://auth0.com/intro-to-iam/what-is-oauth-2](https://auth0.com/intro-to-iam/what-is-oauth-2)
3. [https://goteleport.com/blog/how-oauth-authentication-works/](https://goteleport.com/blog/how-oauth-authentication-works/)
4. [https://www.ibm.com/docs/en/tfimbg/6.2.2.6?topic=overview-oauth-20-workflow](https://www.ibm.com/docs/en/tfimbg/6.2.2.6?topic=overview-oauth-20-workflow)
5. https://docs.vmware.com/en/Single-Sign-On-for-VMware-Tanzu-Application-service/1.11/Single-Sign-On-VMware-Tanzu-Application-service-1-11.pdf